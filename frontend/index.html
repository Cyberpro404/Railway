<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gandiva Rail Safety Monitor</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸš‚</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brand__mark"></div>
        <div class="brand__text">
          <div class="brand__title">Gandiva</div>
          <div class="brand__subtitle">Rail Safety Monitor</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="nav__item is-active" data-tab="connection"><i data-lucide="plug" class="nav__icon"></i><span>Connection</span></button>
        <button class="nav__item" data-tab="overview"><i data-lucide="layout-dashboard" class="nav__icon"></i><span>Dashboard</span></button>
        <button class="nav__item" data-tab="health"><i data-lucide="activity" class="nav__icon"></i><span>Health Metrics</span></button>
          <button class="nav__item" data-tab="mlinsights"><i data-lucide="brain" class="nav__icon"></i><span>ML Insights</span></button>
        <button class="nav__item" data-tab="datasets"><i data-lucide="database" class="nav__icon"></i><span>Datasets</span></button>
        <button class="nav__item" data-tab="logs"><i data-lucide="scroll-text" class="nav__icon"></i><span>Logs</span></button>
        <button class="nav__item" data-tab="alerts"><i data-lucide="bell" class="nav__icon"></i><span>Alerts</span><span class="pill" id="alertsPill">0</span></button>
        <button class="nav__item" data-tab="thresholds"><i data-lucide="sliders" class="nav__icon"></i><span>Thresholds</span></button>
        <button class="nav__item" data-tab="system"><i data-lucide="settings" class="nav__icon"></i><span>Settings</span></button>
      </nav>

      <div class="sidebar__footer">
        <div class="conn">
          <div class="dot" id="connDot"></div>
          <div class="conn__text">
            <div class="conn__label" id="connLabel">Disconnected</div>
            <div class="conn__sub" id="connSub">â€”</div>
          </div>
        </div>
      </div>
    </aside>

    <div class="sidebarBackdrop" id="sidebarBackdrop"></div>

    <!-- ML Alert Banner - OUTSIDE main, fixed at top -->
    <div id="mlAlertBanner" class="ml-banner">
      <div class="ml-banner__inner">
        <div class="ml-banner__icon" id="mlBannerIcon">
          <i data-lucide="shield-check"></i>
        </div>
        <div class="ml-banner__text">
          <span class="ml-banner__label" id="mlAlertText">Waiting for Sensor Data...</span>
          <span class="ml-banner__conf" id="mlAlertConf"></span>
        </div>
      </div>
    </div>

    <div class="main">
      <header class="topbar">
        <!-- Error banner placeholder -->
        <div id="errorBanner" style="display: none; position: fixed; top: 56px; left: 280px; right: 0; z-index: 1000;"></div>
        
        <div class="topbar__left">
          <div class="topbar__menu">
            <button class="iconBtn" id="navToggle" title="Menu"><i data-lucide="menu" class="iconBtn__icon"></i></button>
          </div>
          <div class="pageTitle" id="pageTitle">Connection</div>
          <div class="muted">Professional monitoring panel for QM30VT2</div>
        </div>
        <div class="topbar__right">
          <div class="chip" id="connectionStatus"><i data-lucide="wifi" class="chip__icon"></i><span>Connected</span></div>
          <div class="chip"><i data-lucide="clock" class="chip__icon"></i><span id="clock">â€”</span></div>
          <div class="chip"><i data-lucide="cpu" class="chip__icon"></i><span id="sampleRate">1 Hz</span></div>
          <button class="iconBtn" id="helpBtn" title="Help"><i data-lucide="circle-help" class="iconBtn__icon"></i></button>
        </div>
      </header>

      <section class="tab is-active" id="tab-connection">
        <div class="grid2">
          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Auto-detect</div>
                <div class="card__sub">Scan available COM ports and connect</div>
              </div>
              <button class="btn" id="scanPortsBtn"><i data-lucide="search" class="btn__icon"></i>Search</button>
            </div>
            <div class="formRow">
              <div class="sectionHead" style="margin-top:16px">
                <div>
                  <div class="sectionHead__title">ML Model Control</div>
                  <div class="sectionHead__sub">Reload the trained model from disk without restarting the backend</div>
                </div>
                <button class="btn btn--primary" id="reloadModelBtn">Reload ML Model</button>
              </div>
              <label class="field">
                <span class="field__label">Slave ID</span>
                <input class="input" id="autoSlaveId" type="number" min="1" max="247" value="1" />
              </label>
            </div>
            <div class="tableWrap">
              <table class="table" id="portsTable">
                <thead>
                  <tr><th>Port</th><th>Description</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Manual connection</div>
                <div class="card__sub">Apply settings and connect</div>
              </div>
              <button class="btn btn--primary" id="applyConnBtn"><i data-lucide="plug-zap" class="btn__icon"></i>Apply & Connect</button>
            </div>

            <div class="grid2">
              <label class="field">
                <span class="field__label">COM Port</span>
                <input class="input" id="port" value="COM5" />
              </label>
              <label class="field">
                <span class="field__label">Slave ID</span>
                <input class="input" id="slaveId" type="number" min="1" max="247" value="1" />
              </label>
              <label class="field">
                <span class="field__label">Baudrate</span>
                <select class="input" id="baudrate">
                  <option>9600</option>
                  <option selected>19200</option>
                  <option>38400</option>
                  <option>57600</option>
                  <option>115200</option>
                </select>
              </label>
              <label class="field">
                <span class="field__label">Parity</span>
                <select class="input" id="parity">
                  <option value="N" selected>None (N)</option>
                  <option value="E">Even (E)</option>
                  <option value="O">Odd (O)</option>
                </select>
              </label>
            </div>

            <div class="note">
              Connection uses Modbus RTU 8N1 by default. If you change parity/baud, apply again.
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-overview">
        <!-- Premium ML Prediction Hero Box -->
        <div class="ml-overview-hero" id="mlOverviewHero">
          <div class="ml-overview-hero__main">
            <div class="ml-overview-hero__icon" id="mlOverviewIcon">
              <i data-lucide="shield-check"></i>
            </div>
            <div class="ml-overview-hero__content">
              <div class="ml-overview-hero__label">Real-Time Track Analysis</div>
              <div class="ml-overview-hero__prediction" id="mlOverviewPrediction">INITIALIZING</div>
            </div>
          </div>
          <div class="ml-overview-hero__stats">
            <div class="ml-overview-hero__stat">
              <span class="ml-overview-hero__stat-value" id="mlOverviewConfidence">â€”</span>
              <span class="ml-overview-hero__stat-label">Confidence</span>
            </div>
            <div class="ml-overview-hero__stat">
              <span class="ml-overview-hero__stat-value" id="mlOverviewState">â€”</span>
              <span class="ml-overview-hero__stat-label">Train State</span>
            </div>
            <div class="ml-overview-hero__stat">
              <span class="ml-overview-hero__stat-value" id="mlOverviewModel">â€”</span>
              <span class="ml-overview-hero__stat-label">Model Status</span>
            </div>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="kpi__label">Z RMS</div>
            <div class="kpi__value" id="kpiZ">â€”</div>
            <div class="kpi__sub">mm/s</div>
            <div class="kpi__status" id="kpiZStatus"></div>
          </div>
          <div class="kpi">
            <div class="kpi__label">X RMS</div>
            <div class="kpi__value" id="kpiX">â€”</div>
            <div class="kpi__sub">mm/s</div>
            <div class="kpi__status" id="kpiXStatus"></div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Temperature</div>
            <div class="kpi__value" id="kpiT">â€”</div>
            <div class="kpi__sub">Â°C</div>
            <div class="kpi__status" id="kpiTStatus"></div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Active Alerts</div>
            <div class="kpi__value" id="kpiA">0</div>
            <div class="kpi__sub">items</div>
            <div class="kpi__status kpi__status--neutral"></div>
          </div>
          <div class="kpi" id="kpiMLContainer">
            <div class="kpi__label">ML Prediction</div>
            <div class="kpi__value" id="kpiML">â€”</div>
            <div class="kpi__sub" id="kpiMLConf">No model loaded</div>
            <div class="kpi__status" id="kpiMLStatus"></div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Frequency Snapshot</div>
            <div class="kpi__value" id="kpiFreqHz">â€”</div>
            <div class="kpi__sub" id="kpiFreqRpm">Select a band to see its dominant frequency</div>
            <div class="kpi__cap" id="kpiFreqCap">â€”</div>
            <div class="kpi__status kpi__status--neutral"></div>
          </div>
        </div>

        <div class="sectionHead">
          <div class="sectionHead__title">Training Data Collection</div>
          <div class="sectionHead__sub">Capture current sensor readings for ML training</div>
          <button class="btn btn--primary" id="captureTrainingBtn">Capture training sample</button>
        </div>

        <div class="overviewGrid">
          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Vibration RMS trend</div>
                <div class="card__sub">Z/X RMS velocity (mm/s)</div>
              </div>
            </div>
            <div class="chartBox"><canvas id="chartRms"></canvas></div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Temperature trend</div>
                <div class="card__sub">Surface temperature (Â°C)</div>
              </div>
            </div>
            <div class="chartBox"><canvas id="chartTemp"></canvas></div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">All parameters</div>
                <div class="card__sub">Live scalar metrics with threshold status</div>
              </div>
            </div>
            <div class="paramGrid" id="paramGrid"></div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Spectral bands</div>
                <div class="card__sub">Select a band to inspect</div>
              </div>
              <div class="seg">
                <button class="seg__btn is-active" id="axisZ">Z</button>
                <button class="seg__btn" id="axisX">X</button>
              </div>
            </div>

            <div class="bandLayout">
              <div class="bandList" id="bandList"></div>
              <div class="bandDetail">
                <div class="bandHead" id="bandHead">No band selected</div>
                <div class="bandName" id="bandName"></div>
                <div class="bandCards" id="bandCards"></div>
                <div class="chartBox"><canvas id="chartBand"></canvas></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-health">
        <div class="card">
          <div class="card__head">
            <div>
              <div class="card__title">Health Metrics</div>
              <div class="card__sub">Select a parameter to view its trend</div>
            </div>
            <div class="formRow">
              <label class="field" style="max-width:240px">
                <span class="field__label">Trend window (seconds)</span>
                <select class="input" id="healthWindow">
                  <option value="300">300</option>
                  <option value="600" selected>600</option>
                  <option value="1800">1800</option>
                  <option value="3600">3600</option>
                </select>
              </label>
            </div>
          </div>

          <div class="healthLayout">
            <div>
              <div class="healthGrid" id="healthParamGrid"></div>

              <div class="sectionHead">
                <div>
                  <div class="sectionHead__title">Spectral Bands</div>
                  <div class="sectionHead__sub">Compact view of band RMS and peak frequency</div>
                </div>
                <div class="seg">
                  <button class="seg__btn is-active" id="healthAxisZ">Z</button>
                  <button class="seg__btn" id="healthAxisX">X</button>
                </div>
              </div>

              <div class="tableWrap">
                <table class="table" id="healthBandsTable">
                  <thead>
                    <tr>
                      <th>Band</th><th>Label</th><th>Total RMS</th><th>Peak Hz</th><th>Peak RPM</th><th>Status</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="bandAnalysis">
                <div class="bandAnalysis__head">
                  <div>
                    <div class="sectionHead__title">Band Analysis</div>
                    <div class="sectionHead__sub">Select a band to view RMS + peak frequency trends and snapshot charts</div>
                  </div>
                  <div class="formRow">
                    <div class="seg">
                      <button class="seg__btn is-active" id="bandAxisZ">Z</button>
                      <button class="seg__btn" id="bandAxisX">X</button>
                    </div>
                    <label class="field" style="max-width:180px">
                      <span class="field__label">Band</span>
                      <select class="input" id="healthBandNum"></select>
                    </label>
                  </div>
                </div>

                <div class="bandName" id="healthBandName"></div>
                <div class="bandCards" id="healthBandMetrics"></div>

                <div class="grid2">
                  <div class="cardMini">
                    <div class="cardMini__title">Band RMS vs Time</div>
                    <div class="chartBox" style="height:260px"><canvas id="chartBandRms"></canvas></div>
                  </div>
                  <div class="cardMini">
                    <div class="cardMini__title">Peak Frequency (Hz) vs Time</div>
                    <div class="chartBox" style="height:260px"><canvas id="chartBandFreq"></canvas></div>
                  </div>
                </div>

                <div class="cardMini" style="margin-top:12px">
                  <div class="cardMini__title">All Bands at Current Snapshot</div>
                  <div class="grid2" style="margin-top:10px">
                    <div class="chartBox" style="height:240px"><canvas id="chartAllBandsRms"></canvas></div>
                    <div class="chartBox" style="height:240px"><canvas id="chartSpectrum"></canvas></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="healthDetail">
              <div class="healthDetail__empty" id="healthEmpty">
                Select a parameter card to view its trend.
              </div>

              <div class="healthDetail__panel" id="healthPanel" style="display:none">
                <div class="healthDetail__head">
                  <div>
                    <div class="healthDetail__title" id="healthTitle">â€”</div>
                    <div class="healthDetail__sub"><span class="dotSm" id="healthDot"></span><span id="healthStatus">â€”</span></div>
                  </div>
                  <div class="healthDetail__value" id="healthValue">â€”</div>
                </div>
                <div class="healthStats" id="healthStats"></div>
                <div class="chartBox" style="height:280px"><canvas id="chartHealth"></canvas></div>

                <div class="grid2" style="margin-top:12px">
                  <div class="cardMini" id="isoPanel">
                    <div class="cardMini__title">ISO 10816 Severity</div>
                    <div class="cardMini__body" id="isoPanelBody"></div>
                  </div>
                  <div class="cardMini" id="bearingPanel">
                    <div class="cardMini__title">Bearing Health</div>
                    <div class="cardMini__body" id="bearingPanelBody"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-logs">
        <div class="card">
          <div class="card__head">
            <div>
              <div class="card__title">Logs / History</div>
              <div class="card__sub">Recent readings (client-side pagination)</div>
            </div>
            <div class="formRow">
              <label class="field" style="max-width:240px">
                <span class="field__label">Window (seconds)</span>
                <select class="input" id="logsWindow">
                  <option value="600">600</option>
                  <option value="1800">1800</option>
                  <option value="3600" selected>3600</option>
                </select>
              </label>
              <button class="btn" id="logsRefreshBtn"><i data-lucide="refresh-cw" class="btn__icon"></i>Refresh</button>
              <div class="pager">
                <button class="btn" id="logsPrevBtn">Prev</button>
                <div class="pager__info" id="logsPageInfo">â€”</div>
                <button class="btn" id="logsNextBtn">Next</button>
              </div>
            </div>
          </div>
          <div class="tableWrap">
            <table class="table" id="logsTable">
              <thead>
                <tr>
                  <th>Timestamp</th><th>Z RMS</th><th>X RMS</th><th>Temp</th><th>Highest Band RMS</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ML Insights Tab - Premium Design -->
      <section class="tab" id="tab-mlinsights">
        <!-- Hero Status Section -->
        <div class="ml-hero">
          <div class="ml-hero__main">
            <div class="ml-hero__icon" id="mlHeroIcon">
              <div class="ml-hero__pulse"></div>
              <i data-lucide="brain"></i>
            </div>
            <div class="ml-hero__content">
              <div class="ml-hero__label">Real-Time Track Condition</div>
              <div class="ml-hero__prediction" id="mlHeroPrediction">INITIALIZING</div>
              <div class="ml-hero__meta">
                <span class="ml-hero__confidence" id="mlHeroConfidence">
                  <i data-lucide="target"></i> Confidence: â€”
                </span>
                <span class="ml-hero__time" id="mlHeroTime">
                  <i data-lucide="clock"></i> Last: â€”
                </span>
              </div>
            </div>
          </div>
          <div class="ml-hero__actions">
            <button class="btn btn--glass" id="mlCaptureBtn">
              <i data-lucide="camera" class="btn__icon"></i>Capture Sample
            </button>
            <button class="btn btn--glass" id="mlRefreshBtn">
              <i data-lucide="refresh-cw" class="btn__icon"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="ml-stats">
          <div class="ml-stat ml-stat--normal">
            <div class="ml-stat__ring">
              <svg viewBox="0 0 36 36">
                <path class="ml-stat__ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                <path class="ml-stat__ring-fill" id="ringNormal" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              </svg>
              <div class="ml-stat__icon"><i data-lucide="check-circle"></i></div>
            </div>
            <div class="ml-stat__body">
              <div class="ml-stat__value" id="mlNormalCount">0</div>
              <div class="ml-stat__label">Normal Track</div>
              <div class="ml-stat__percent" id="mlNormalPercent">0%</div>
            </div>
          </div>
          <div class="ml-stat ml-stat--gap">
            <div class="ml-stat__ring">
              <svg viewBox="0 0 36 36">
                <path class="ml-stat__ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                <path class="ml-stat__ring-fill" id="ringGap" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              </svg>
              <div class="ml-stat__icon"><i data-lucide="minus-circle"></i></div>
            </div>
            <div class="ml-stat__body">
              <div class="ml-stat__value" id="mlGapCount">0</div>
              <div class="ml-stat__label">Expansion Gap</div>
              <div class="ml-stat__percent" id="mlGapPercent">0%</div>
            </div>
          </div>
          <div class="ml-stat ml-stat--crack">
            <div class="ml-stat__ring">
              <svg viewBox="0 0 36 36">
                <path class="ml-stat__ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                <path class="ml-stat__ring-fill" id="ringCrack" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              </svg>
              <div class="ml-stat__icon"><i data-lucide="alert-triangle"></i></div>
            </div>
            <div class="ml-stat__body">
              <div class="ml-stat__value" id="mlCrackCount">0</div>
              <div class="ml-stat__label">Crack Detected</div>
              <div class="ml-stat__percent" id="mlCrackPercent">0%</div>
            </div>
          </div>
          <div class="ml-stat ml-stat--total">
            <div class="ml-stat__ring">
              <svg viewBox="0 0 36 36">
                <path class="ml-stat__ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                <path class="ml-stat__ring-fill" id="ringTotal" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
              </svg>
              <div class="ml-stat__icon"><i data-lucide="activity"></i></div>
            </div>
            <div class="ml-stat__body">
              <div class="ml-stat__value" id="mlTotalCount">0</div>
              <div class="ml-stat__label">Total Predictions</div>
              <div class="ml-stat__percent" id="mlAvgConfidence">Avg: 0%</div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="ml-charts">
          <div class="glass-card">
            <div class="glass-card__head">
              <div class="glass-card__title">
                <i data-lucide="pie-chart"></i>
                <span>Prediction Distribution</span>
              </div>
            </div>
            <div class="glass-card__body">
              <div class="chart-container" style="height:260px">
                <canvas id="chartMlDistribution"></canvas>
              </div>
            </div>
          </div>
          <div class="glass-card">
            <div class="glass-card__head">
              <div class="glass-card__title">
                <i data-lucide="bar-chart-3"></i>
                <span>Confidence Analysis</span>
              </div>
            </div>
            <div class="glass-card__body">
              <div class="chart-container" style="height:260px">
                <canvas id="chartMlConfidence"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Model Info Card -->
        <div class="glass-card glass-card--wide">
          <div class="glass-card__head">
            <div class="glass-card__title">
              <i data-lucide="cpu"></i>
              <span>ML Model Status</span>
            </div>
            <button class="btn btn--sm btn--accent" id="mlReloadBtn2">
              <i data-lucide="refresh-cw" class="btn__icon"></i>Reload Model
            </button>
          </div>
          <div class="glass-card__body">
            <div class="model-grid">
              <div class="model-item">
                <div class="model-item__icon is-success" id="modelStatusIcon"><i data-lucide="check-circle"></i></div>
                <div class="model-item__content">
                  <div class="model-item__label">Status</div>
                  <div class="model-item__value" id="mlModelStatus">Loading...</div>
                </div>
              </div>
              <div class="model-item">
                <div class="model-item__icon"><i data-lucide="file-code"></i></div>
                <div class="model-item__content">
                  <div class="model-item__label">Model File</div>
                  <div class="model-item__value" id="mlModelFile">gandiva_vib_model.joblib</div>
                </div>
              </div>
              <div class="model-item">
                <div class="model-item__icon"><i data-lucide="layers"></i></div>
                <div class="model-item__content">
                  <div class="model-item__label">Classes</div>
                  <div class="model-item__value" id="mlModelClasses">normal, expansion_gap, crack</div>
                </div>
              </div>
              <div class="model-item">
                <div class="model-item__icon" id="scalerStatusIcon"><i data-lucide="sliders"></i></div>
                <div class="model-item__content">
                  <div class="model-item__label">Scaler</div>
                  <div class="model-item__value" id="mlScalerStatus">Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Predictions Table -->
        <div class="glass-card glass-card--wide">
          <div class="glass-card__head">
            <div class="glass-card__title">
              <i data-lucide="history"></i>
              <span>Recent Predictions</span>
            </div>
            <span class="badge" id="predictionCountBadge">0 predictions</span>
          </div>
          <div class="glass-card__body glass-card__body--table">
            <table class="premium-table" id="mlPredictionsTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Prediction</th>
                  <th>Confidence</th>
                  <th>Z RMS</th>
                  <th>X RMS</th>
                  <th>Temp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Datasets Tab - Premium Design -->
      <section class="tab" id="tab-datasets">
        <!-- Datasets Hero -->
        <div class="ds-hero">
          <div class="ds-hero__content">
            <h2 class="ds-hero__title">Training Datasets</h2>
            <p class="ds-hero__sub">Manage CSV datasets for ML model training</p>
          </div>
          <div class="ds-hero__actions">
            <button class="btn btn--accent" id="captureDataBtn">
              <i data-lucide="plus-circle" class="btn__icon"></i>Capture Data
            </button>
            <button class="btn btn--glass" id="refreshDatasetsBtn">
              <i data-lucide="refresh-cw" class="btn__icon"></i>Refresh
            </button>
          </div>
        </div>

        <!-- Stats Row -->
        <div class="ds-stats">
          <div class="ds-stat">
            <div class="ds-stat__icon"><i data-lucide="files"></i></div>
            <div class="ds-stat__body">
              <div class="ds-stat__value" id="totalDatasetsCount">0</div>
              <div class="ds-stat__label">Datasets</div>
            </div>
          </div>
          <div class="ds-stat">
            <div class="ds-stat__icon is-cyan"><i data-lucide="table-2"></i></div>
            <div class="ds-stat__body">
              <div class="ds-stat__value" id="totalRowsCount">0</div>
              <div class="ds-stat__label">Total Rows</div>
            </div>
          </div>
          <div class="ds-stat">
            <div class="ds-stat__icon is-purple"><i data-lucide="hard-drive"></i></div>
            <div class="ds-stat__body">
              <div class="ds-stat__value" id="totalSizeCount">0 KB</div>
              <div class="ds-stat__label">Total Size</div>
            </div>
          </div>
          <div class="ds-stat">
            <div class="ds-stat__icon is-green"><i data-lucide="tags"></i></div>
            <div class="ds-stat__body">
              <div class="ds-stat__value" id="totalLabelsCount">0</div>
              <div class="ds-stat__label">Labels</div>
            </div>
          </div>
        </div>

        <!-- Dataset Grid -->
        <div class="ds-grid" id="datasetsList">
          <div class="ds-empty">
            <i data-lucide="folder-open"></i>
            <h3>Loading Datasets...</h3>
            <p>Scanning data directory for CSV files</p>
          </div>
        </div>

        <!-- Dataset Preview Modal -->
        <div class="ds-modal" id="datasetPreview" style="display:none">
          <div class="ds-modal__backdrop" onclick="closeDatasetPreview()"></div>
          <div class="ds-modal__content">
            <div class="ds-modal__head">
              <div>
                <h3 class="ds-modal__title" id="previewFilename">Dataset</h3>
                <p class="ds-modal__sub" id="previewInfo">Loading...</p>
              </div>
              <button class="btn btn--icon" onclick="closeDatasetPreview()">
                <i data-lucide="x"></i>
              </button>
            </div>
            <div class="ds-modal__body">
              <!-- Label Chart -->
              <div class="ds-modal__chart">
                <h4>Label Distribution</h4>
                <div class="chart-container" style="height:180px">
                  <canvas id="chartDatasetLabels"></canvas>
                </div>
              </div>
              <!-- Data Table -->
              <div class="ds-modal__table">
                <table class="premium-table" id="datasetPreviewTable">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="ds-modal__foot">
              <div class="ds-modal__pagination">
                <button class="btn btn--sm" id="datasetPrevBtn"><i data-lucide="chevron-left"></i></button>
                <span id="datasetPageInfo">Page 1</span>
                <button class="btn btn--sm" id="datasetNextBtn"><i data-lucide="chevron-right"></i></button>
              </div>
              <div class="ds-modal__actions">
                <button class="btn btn--danger" id="deleteDatasetBtn">
                  <i data-lucide="trash-2" class="btn__icon"></i>Delete
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Capture Modal -->
        <div class="capture-modal" id="captureModal" style="display:none">
          <div class="capture-modal__backdrop" onclick="closeCaptureModal()"></div>
          <div class="capture-modal__content">
            <div class="capture-modal__head">
              <h3>Capture Training Sample</h3>
              <button class="btn btn--icon" onclick="closeCaptureModal()"><i data-lucide="x"></i></button>
            </div>
            <div class="capture-modal__body">
              <div class="capture-preview">
                <div class="capture-preview__item">
                  <span class="capture-preview__label">Z RMS</span>
                  <span class="capture-preview__value" id="captureZRms">â€”</span>
                </div>
                <div class="capture-preview__item">
                  <span class="capture-preview__label">X RMS</span>
                  <span class="capture-preview__value" id="captureXRms">â€”</span>
                </div>
                <div class="capture-preview__item">
                  <span class="capture-preview__label">Temp</span>
                  <span class="capture-preview__value" id="captureTemp">â€”</span>
                </div>
              </div>
              <div class="capture-form">
                <label class="capture-label">
                  <span>Label</span>
                  <select id="captureLabel" class="input">
                    <option value="normal">Normal Track</option>
                    <option value="expansion_gap">Expansion Gap</option>
                    <option value="crack">Crack / Defect</option>
                  </select>
                </label>
                <label class="capture-label">
                  <span>Notes (optional)</span>
                  <input type="text" id="captureNotes" class="input" placeholder="Add notes...">
                </label>
              </div>
            </div>
            <div class="capture-modal__foot">
              <button class="btn btn--secondary" onclick="closeCaptureModal()">Cancel</button>
              <button class="btn btn--accent" id="confirmCaptureBtn">
                <i data-lucide="save" class="btn__icon"></i>Save Sample
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-system">
        <div class="grid2">
          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">System Info</div>
                <div class="card__sub">Quick diagnostics for field use</div>
              </div>
            </div>
            <div class="kv" id="systemKv"></div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Connection</div>
                <div class="card__sub">Current Modbus settings</div>
              </div>
            </div>
            <div class="kv" id="connKv"></div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">ML Model Status</div>
                <div class="card__sub">Backend model &amp; scaler health</div>
              </div>
              <button class="btn" id="mlStatusRefreshBtn"><i data-lucide="refresh-ccw" class="btn__icon"></i>Refresh</button>
            </div>
            <div class="kv" id="mlStatusKv"></div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-alerts">
        <div class="grid2">
          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Alerts</div>
                <div class="card__sub">Active/ack/cleared</div>
              </div>
              <div class="rowActions">
                <button class="btn" id="exportCsvBtn"><i data-lucide="download" class="btn__icon"></i>Export CSV</button>
              </div>
            </div>
            <div class="tableWrap">
              <table class="table" id="alertsTable">
                <thead>
                  <tr><th>Time</th><th>Severity</th><th>Parameter</th><th>Value</th><th>Threshold</th><th>Status</th><th></th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Sound</div>
                <div class="card__sub">Optional server-side beep control</div>
              </div>
            </div>
            <div class="formRow">
              <button class="btn btn--primary" id="toggleSoundBtn">Toggle sound</button>
              <button class="btn" id="testBeepBtn">Test beep</button>
            </div>
            <div class="note" id="soundState">Sound: unknown</div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-thresholds">
        <div class="grid2">
          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Scalar thresholds</div>
                <div class="card__sub">Warning/alarm limits</div>
              </div>
              <button class="btn btn--primary" id="saveThresholdsBtn"><i data-lucide="save" class="btn__icon"></i>Save thresholds</button>
            </div>
            <div class="grid2">
              <label class="field"><span class="field__label">Z RMS warning</span><input class="input" id="th_z_warn" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">Z RMS alarm</span><input class="input" id="th_z_alarm" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">X RMS warning</span><input class="input" id="th_x_warn" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">X RMS alarm</span><input class="input" id="th_x_alarm" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">Temp warning</span><input class="input" id="th_t_warn" type="number" min="0" step="0.1" /></label>
              <label class="field"><span class="field__label">Temp alarm</span><input class="input" id="th_t_alarm" type="number" min="0" step="0.1" /></label>
            </div>
            <div class="note">Alarm must be >= warning.</div>
          </div>

          <div class="card">
            <div class="card__head">
              <div>
                <div class="card__title">Band thresholds</div>
                <div class="card__sub">Edit one band and save</div>
              </div>
            </div>
            <div class="grid2">
              <label class="field"><span class="field__label">Axis</span>
                <select class="input" id="bandAxisSelect"><option value="z">Z</option><option value="x">X</option></select>
              </label>
              <label class="field"><span class="field__label">Band #</span>
                <input class="input" id="bandNumSelect" type="number" min="1" max="20" value="1" />
              </label>
              <label class="field"><span class="field__label">Total RMS warning</span><input class="input" id="band_total_warn" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">Total RMS alarm</span><input class="input" id="band_total_alarm" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">Peak RMS warning</span><input class="input" id="band_peak_warn" type="number" min="0" step="0.001" /></label>
              <label class="field"><span class="field__label">Peak RMS alarm</span><input class="input" id="band_peak_alarm" type="number" min="0" step="0.001" /></label>
            </div>
            <div class="formRow">
              <button class="btn" id="applyBandBtn">Apply band</button>
              <button class="btn" id="applyAllBtn">Apply to all bands (axis)</button>
            </div>
            <div class="note">This config is stored in memory (restart resets unless you persist it later).</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="modal__backdrop" id="helpBackdrop"></div>
    <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="modal__head">
        <div class="modal__title" id="helpTitle">Gandiva Guide</div>
        <button class="iconBtn" id="helpClose" title="Close"><i data-lucide="x" class="iconBtn__icon"></i></button>
      </div>
      <div class="modal__body">
        <div class="helpGrid">
          <div class="helpBlock">
            <div class="helpBlock__title">Z/X RMS velocity</div>
            <div class="helpBlock__text">Overall vibration energy in mm/s. Higher RMS generally indicates worsening mechanical condition or track-induced vibration.</div>
          </div>
          <div class="helpBlock">
            <div class="helpBlock__title">Peak velocity</div>
            <div class="helpBlock__text">Maximum observed vibration velocity in the sampling interval. Useful for transient events and impacts.</div>
          </div>
          <div class="helpBlock">
            <div class="helpBlock__title">Bands</div>
            <div class="helpBlock__text">Spectral bands summarize vibration energy in frequency bins. Each band has total RMS and peak frequency (dominant component).</div>
          </div>
          <div class="helpBlock">
            <div class="helpBlock__title">Threshold colors</div>
            <div class="helpBlock__text">Green = normal, Amber = warning, Red = alarm. Thresholds are configured in the Thresholds tab.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
  <script src="./training.js"></script>
  <script>lucide.createIcons();</script>
</body>
</html>
